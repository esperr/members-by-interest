<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
  <title>Find a Member by Interest</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" href="byinterest.css">
  <style type="text/css">
  @font-face {
    font-family: 'Roboto';
    font-style: normal;
    font-weight: 400;
    src: url(https://fonts.gstatic.com/s/roboto/v15/Fcx7Wwv8OzT71A3E1XOAjvesZW2xOQ-xsNqO47m55DA.woff2) format('woff2');
  }
  </style>
  <script>
    //Google analytics script goes here!
  </script>
</head>

<!--
Designed and built by Ed Sperr (esperr@uga.edu or ed_sperr@hotmail.com)
-->
<body>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <div class="container">

  <div id="topbanner" class="jumbotron">
    <h1>Members by Interest</h1>
    <a id="about" class="label label-default" href="about.html">About Members by Interest</a>
  </div>
  <div class="row">
    <div class="col-sm-12 col-md-12 col-lg-12">


<div id="searchoptions">
  <div class="search">Chamber and years:

  <select id="chamber">
      <option value="house" selected>House of Representatives</option>
      <option value="senate">Senate</option>
    </select>

  <select id="congress">
      <option value="113" selected>113</option>
      <option value="114">114</option>
      <option value="115">115</option>
      <option value="all">113th - 115th</option>
    </select>th congress
  </div>

  <div class="search">

    <a id="subjecttoggle" href="#">All Members by Subject or Policy Area</a> | <a id="membertoggle" href="#">View Interests for single Member</a>
  </div>

    <div id="togglesubject" class="btn-group btn-group-toggle" data-toggle="buttons">
      <label class="btn btn-primary btn-sm active">
        <input type="radio" name="subjecttype" value="policy" autocomplete="off" checked> Policy Area
      </label>
      <label class="btn btn-primary btn-sm">
        <input type="radio" name="subjecttype" value="subject" autocomplete="off"> Legislative Subjects
      </label>
    </div>
  </div>

  <div id="results">
  <div id="membersearch">
        <label for="memberlisting">Choose a Member</label>
      <select id="memberlisting">
         </select>
         <div id="memberresults">
      </div>
    </div>

  <div id="subjectsearch">
    <br />
    <label id=subjecttypelabel for="subjectlisting"></label>
     <select id="subjectlisting">
    </select>
    <div id="subjectresults">
    </div>
  </div>
</div>



</div>
</div>
   <script>
   var chamber = $( "#chamber option:selected" ).val();
   var congress = $( "#congress option:selected" ).val();
   var classification = "policyareas";
   var subjecttype;
   //var type = $('input[name=searchtype]:checked').val();

   var members;
   var filenameStem = "https://esperr.github.io/members-by-interest/data/"

   //grab our members first!
   getMembers();
   google.charts.load('current', {packages: ['corechart', 'bar']});

   //start by showing only subject search
   $( "#membersearch" ).toggle();

   $( "#subjectlisting" ).change(function() {
     memberrank();
   });

   $( "#memberlisting" ).change(function() {
     member = $( "#memberlisting option:selected" ).val();
     topsubjects(member);
   });

   $( "#subjecttoggle" ).click(function() {
     $( "#membersearch" ).toggle();
     $( "#subjectsearch" ).toggle();
     //type = "subject";
   });

   $( "#membertoggle" ).click(function() {
     $( "#membersearch" ).toggle();
     $( "#subjectsearch" ).toggle();
     //type = "member";
   });

   $('#togglesubject input').on('change', function() {
     getSubjects();
   });

   $( "#congress" ).change(function() {
     congress = $( "#congress option:selected" ).val();
     getMembers();
   });

   $( "#chamber" ).change(function() {
     chamber = $( "#chamber option:selected" ).val();
     pickMembers();
     getSubjects();
   });

   function pickMembers() {
     $('#memberlisting').empty();
     var sortedMembers = membersort(members);
     var auxArr = [];
     $.each(sortedMembers, function(i, member)
       {
         if (chamber == "house" && member['district']) {
           auxArr[i] = "<option value='" + member['bioid'] + "'>" + member['fullname'] + "</option>";
         }
         if (chamber == "senate" && !member['district']) {
           auxArr[i] = "<option value='" + member['bioid'] + "'>" + member['fullname'] + "</option>";
         }
       });
      $('#memberlisting').append(auxArr.join(''));

   }

   function memberrank() {
     subject = $( "#subjectlisting option:selected" ).val();
     var ranklist = [];
     var memberlink = "https://www.congress.gov/member/";
     $.each( allsubjects[subject], function( key, value ) {
       var sponsored = value['sponsored'] || 0;
       var cosponsored = value['cosponsored'] || 0;
       var score = (sponsored*3) + cosponsored;
       //sort chambers here?
       if (score > 0) {
         var result = members.filter(function( member ) {
           return member.bioid == key;
         });
         var mymember = (result[0]);
         if (mymember) {
           var memberobj = { "fullname": mymember.fullname, "firstname": mymember.firstname, "lastname": mymember.lastname, "bioid": key, "score": score, "sponsored": sponsored, "cosponsored": cosponsored };
           if (chamber == "house" && mymember.district) {
             ranklist.push(memberobj);
           }
           if (chamber == "senate" && !mymember.district) {
             ranklist.push(memberobj);
           }
         }
       }
       });
       var ranked = keysrt(ranklist, 'score', 'reverse');
       $( "#subjectresults" ).empty();
       for (i=0; i<ranked.length; i++) {
           var membersearchStr = memberlink + ranked[i].firstname + "-" + ranked[i].lastname + "/" + ranked[i].bioid;
           var mydiv = "<div class='member'><span class='name'><a href='" + membersearchStr + "' target='member'>" + ranked[i].fullname + "</a></span>";
           var billsearchParams = { "congress": congress, "subject": subject.replace(/_/g, ' ')};
           if (congress == "all") {
             billsearchParams.congress = ["115","114","113"];
           }
           billsearchParams.sponsorship = "sponsored";
           mydiv = mydiv + "<br /><span class='counts'>Sponsored: <a href='" + membersearchStr + "?q=" + JSON.stringify(billsearchParams) + "' target='sponsorship'>" + ranked[i].sponsored + "</a>"
           billsearchParams.sponsorship = "cosponsored";
           mydiv = mydiv + " Cosponsored: <a href='" + membersearchStr + "?q=" + JSON.stringify(billsearchParams) + "' target='sponsorship'>" + ranked[i].cosponsored + "</a></span></div>"
           $( "#subjectresults" ).append( mydiv );
       }
   }

   function topsubjects(member) {
     var interests = [];
     $( "#memberresults" ).empty();
     $.each( allsubjects, function( key, value ) {
       var scanSubject = allsubjects[key];
       if (scanSubject[member]) {
         var sponsored = scanSubject[member]['sponsored'] || 0;
         var cosponsored = scanSubject[member]['cosponsored'] || 0;
         var bills = sponsored + cosponsored;
         var proportion = bills / scanSubject['total'];
         var subjectObj = { "member": member, "subject": key, "bills": bills, "proportion": proportion };
         interests.push(subjectObj);
       }
     });
     var ranked = keysrt(interests, 'proportion', 'reverse');
     var proparray = [];
     var labels = ['Subject', 'Proportion',]
     proparray.push(labels);
     for (i=0; i<ranked.length; i++){
       var nounder = ranked[i].subject.replace(/_/g, ' ');
       proparray.push([nounder, ranked[i].proportion]);
     }
     drawchart(proparray);
   }

   function getSubjects() {
     subjecttype = $('input[name=subjecttype]:checked').val();
     $("#subjecttypelabel").empty();
     $('#subjectlisting').empty();
     if (subjecttype == "policy") {
       var filename = filenameStem + "policyareasbymember_" + congress + "_" + chamber + ".js";
       $("#subjecttypelabel").append("Choose a Policy Area:");
     } else {
       $("#subjecttypelabel").append("Choose a Legislative Subject:");
       var filename = filenameStem + "subjectsbymember_" + congress + "_" + chamber + ".js";
     }
     $.getJSON( filename, function( data ) {
       allsubjects = data;
       var subjects = [];
       for (subject in allsubjects) {
         subjects.push(subject);
         subjects.sort();
       }
       var auxArr = [];
       $.each(subjects, function(i, subject)
         { var nounder = subject.replace(/_/g, ' ');
           auxArr[i] = "<option value='" + subject + "'>" + nounder + "</option>";
         });
       $('#subjectlisting').append(auxArr.join(''));
     })
     .done(function() {
       memberrank();
     })
     .fail(function() {
       alert( "There was some sort of problem -- please reload the page" );
     });
  }

   function getMembers() {
     filename = filenameStem + "members_" + congress + ".js";
     $.getJSON( filename, function( data ) {
       members = data;
       pickMembers();
     })
     .done(function() {
       getSubjects();
     })
     .fail(function() {
       alert( "There was some sort of problem -- please reload the page" );
     });
   }

   function drawchart(proparray) {
     console.log(JSON.stringify(proparray.length));
     newHeight = proparray.length * 20;
     var divStyle = "width: 900px; height:" + String(newHeight) + "px;"
     $( "#memberresults" ).append("<div id='chart_div' style='" + divStyle +"'></div>")
         var data = google.visualization.arrayToDataTable(proparray);
     if (subjecttype == "subject") {
       var titletext = "Bills by Legislative Subject";
     } else {
       var titletext = "Bills by Policy Area";
     }

    var options = {
      chart: {
                  title: titletext,
                  subtitle: 'Sponsored and cosponsored as proportion of all Bills',
                },
      chartArea: {width: '50%'},
      hAxis: {
        title: 'Proportion',
        minValue: 0
      },
      vAxis: {
        title: 'Subject'
      },
      bars: 'horizontal' // Required for Material Bar Charts.

    };

    var chart = new google.charts.Bar(document.getElementById('chart_div'));
    chart.draw(data, google.charts.Bar.convertOptions(options));
    }


   function membersort(sortMembers) {
     var sorted = keysrt(sortMembers, "lastname");
     return sorted;
   }

   function membermatch(bioid) {
     for (i=0; i<members.length; i++) {
       if (members[i].bioid == bioid) return members[i];
     }
   }

   function keysrt(arr, key, reverse) {
       var sortOrder = 1;
       if(reverse){
           sortOrder = -1;
       }
       return arr.sort(function(a, b) {
           var x = a[key],
               y = b[key];

           return sortOrder * ((x < y) ? -1 : ((x > y) ? 1 : 0));
       });
   }
   </script>
   <footer class="footer">
     <div class="container">
       <span class="text-muted">  <p>Design and contruction by Ed Sperr, M.L.I.S. (<a href="mailto:ed_sperr@hotmail.com">ed_sperr@hotmail.com</a>)   |
         Data from <a href="https://www.gpo.gov/fdsys/bulkdata/BILLSTATUS">GPO</a>  |   Charting tools from  <a href="https://developers.google.com/chart/interactive/docs/gallery/barchart"> target="_blank">Google</a>
        | See the code at <a href="https://github.com/esperr/members-by-interest">GitHub</a></p></span>
     </div>
   </footer>
 </body>
</html>
