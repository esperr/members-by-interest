<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
  <title>Find a Member by Interest</title>
  <link href="https://fonts.googleapis.com/css?family=Merriweather" rel="stylesheet">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" href="byinterest.css">
  <!-- Global site tag (gtag.js) - Google Analytics -->

</head>

<!--
Designed and built by Ed Sperr (esperr@uga.edu or ed_sperr@hotmail.com)
-->

<body>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>

  <div class="container">

  <div id="topbanner" class="jumbotron">
    <h1>Members by Interest</h1>
    <a id="about" class="label label-default" href="about.html">About Members by Interest</a>
  </div>
  <div class="row">
    <div class="col-sm-12 col-md-12 col-lg-12">


<div id="searchoptions">
  <div class="search">Chamber and years:

  <select id="chamber">
      <option value="house" selected>House of Representatives</option>
      <option value="senate">Senate</option>
    </select>

  <select id="congress">
    </select>th Congress
  </div>
    </div>

    <div id="subjectsearch">
      <div id="subjectpicker">

      Subject type: <select id="subjecttype">
          <option value="policy">policy area</option>
          <option value="subject">legislative subject</option>
        </select>
        <div id="showbutton">
        <button id="subjectsearch-trigger" class="btn btn-default" type="button">Search for subject by text</button>
        or </div>

        <label class=subjecttypelabel for="subjectlisting"></label>
        <select id="subjectlisting"></select>
      </div>
      <p>Scatterplot showing the relationship between engagement in a given topic (as measured by <a href="about.html#howtoadjust">adjusted score</a>) and indeological polarization (as measured
        by Dimension 1 <a href="https://voteview.com/about">DW-NOMINATE</a> scores).</p>
        <p><em>Hover over any point on the chart to see more information for that member</em></p>
        <p>Share this search: <a href="#!" class="shareLink">Link</a></p>

      <div id="subjectresults">
      </div>

    </div>
  </div>
</div>


</div>

<div id="sharing-link" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Share this search</h4>
      </div>
      <div class="modal-body">
        <input type="text" id="sharingUrlcontent">
      </div>
      <div class="modal-footer">
        <p>Copy the link above</p>
      </div>
    </div>
  </div>
</div>

<div id="please-wait" class="modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Please wait!</h4>
      </div>
      <div class="modal-body">
        <div class="loading">
        <p>Fetching your results...</p>
        <img src="loading-bars.svg">
      </div>
      </div>
    </div>
  </div>
</div>

   <script>
   var subject;
   //var subjecttype = "policy";
   var queryDict = {};
   var chamber = $( "#chamber option:selected" ).val();
   //var congress = $( "#congress option:selected" ).val();
   var congresses;
   var legsubjects = {};
   var legsubjectslist = [];
   var policies = {};
   var policieslist = [];
   var subjectsarray = [];
   var membersarray = [];
   var currentLocation = location.hostname + location.pathname;
   var members;
   var graphDivWidth = $( "#subjectsearch" ).width();
   if (graphDivWidth < 700) { graphDivWidth = 700 }

   //grab our members first!
   $('#please-wait').modal();
   getAllMembers();
   getAllSubjects();

   $( "#subjectlisting" ).change(function() {
     subject = $( "#subjectlisting option:selected" ).val();
     subjectSearch(subject);
   });

   $( "#subjecttoggle" ).click(function() {
     subject = $( "#subjectlisting option:selected" ).val();
     alert(subject);
   });

   $( "#subjectsearch-trigger, #splashsubjectsearch-trigger" ).click(function() {
     $( "#search-subjects" ).modal();
   });

    $( "#subjecttype" ).change(function() {
      subjecttype = $( "#subjecttype option:selected" ).val();
      listSubjects();
    });

   $( "#congress" ).change(function() {
     congress = $( "#congress option:selected" ).val();
     $('#please-wait').modal();
     getAllScores(congress);
     $("#subjectresults").empty();
   });

   $( "#chamber" ).change(function() {
     chamber = $( "#chamber option:selected" ).val();
     subject = $( "#subjectlisting option:selected" ).val();
     subjectSearch(subject);
   });

   $( "#myMemberInput" ).keyup(function() {
     $( "#memberdrop" ).empty();
     var input = $( "#myMemberInput" ).val().toUpperCase();
     $.each(membersarray, function(i, member) {
         var matchstr = member['fullname'] + " &mdash; " + member['state'];
         if (member['district']) { matchstr = matchstr + " " + member['district']; }
         if (matchstr.toUpperCase().indexOf(input) > -1) {
           $( "#memberdrop" ).append("<li><a class='listmember' href='#'>" + matchstr + "</a></li>");
           $( ".listmember" ).last().data( "bioid", member.bioid );
         }
     });
    });

     $( "#mySubjectInput" ).keyup(function() {
       $( "#subjectdrop" ).empty();
       var input = $( "#mySubjectInput" ).val();
       filter = input.toUpperCase();
       $.each(subjectsarray, function(i, subject)
         {
             var matchstr = subject;
             if (matchstr.toUpperCase().indexOf(filter) > -1) {
               $( "#subjectdrop" ).append("<li><a class='listsubject' href='#'>" + subject + "</a></li>");
             }
       });
     });

     $( "#subjectsearch" ).on( "click", ".shareLink", function() {
        $('#sharing-link').modal();
     });

   function querysearch() {
     location.search.substr(1).split("&").forEach(function(item) {
         queryDict[item.split("=")[0]] = item.split("=")[1]
     });
     if (queryDict["chamber"]) {$("#chamber").val(queryDict["chamber"])}
     if (queryDict["subjecttype"]) {
       subjecttype = queryDict["subjecttype"];
       $("#subjecttype").val(subjecttype);
     }
     if (queryDict["congress"]) {$("#congress").val(queryDict["congress"])}
     if (queryDict["subject"]) {
       subject = (decodeURIComponent(queryDict["subject"]));
     }
     //window.location.replace(currentLocation);
     subjectSearch(subject);
   }

   function subjectSearch(subject) {
     $('#please-wait').modal();
     var searchsubjecttype = "policy"
     if (subjecttype == "subject") { searchsubjecttype = "legsubject" }
     filename = "https://fetch-bill-statuses.appspot.com/subjectsearch?chamber=" + chamber + "&subject=" + subject + "&subjecttype=" + searchsubjecttype + "&congress=" + congress;
     $.getJSON( filename, function( data ) {

     })
     .done(function(data) {
       var memberscores = [];
       if (chamber == "house") {
         var subjbase = "House";
       } else {
         var subjbase = "Senate";
       }
       subjectresponse = data.members;
       //for (var key in subjectresponse) {
      //   if (searches.hasOwnProperty(key)) {
      //   }
      // }


       $.each(subjectresponse, function(i, membernumbers) {
           var sponsored = membernumbers['sponsored'] || 0;
           var originalcosponsored = membernumbers['originalcosponsored'] || 0;
           var cosponsored = membernumbers['cosponsored'] || 0;
           var score = sponsored + (originalcosponsored*.2) +  (cosponsored*.1);
           if (members[subjbase][i]) {
             var memberscore = members[subjbase][i][congress];
             if (typeof memberscore !== "undefined") {
               memberscore["Sponsored"] = sponsored;
               memberscore["Cosponsored"] = originalcosponsored + cosponsored;
               memberscore["Name"] = members[subjbase][i]["Fullname"];
               memberscore["Subjectscore"] = score;
               memberscore["ID"] = i;
               memberscores.push(memberscore);
             }
         } else {
           console.log("Problem member:" + i);
         }
       });
        $('#please-wait').modal('hide');

        plotscores(memberscores);
        $("#subjectlisting").val(subject);
        var myQuerystring = "congress=" + congress + "&chamber=" + chamber + "&subjecttype=" + subjecttype + "&subject=" + subject;
        var shareUrl = currentLocation + "?" +  myQuerystring;
        if (congress == "all") {
          var scattercongress = congresses[congresses.length-1];
        } else {
          var scattercongress = congress;
        }
        var scatterQuerystring = "congress=" + scattercongress + "&chamber=" + chamber + "&subjecttype=" + subjecttype + "&subject=" + subject;
        var scatterUrl = "nomscatter.html?" +  scatterQuerystring;
        $( "#sharingUrlcontent" ).attr( "style", "width: 35em;" );
        $( "#sharingUrlcontent" ).attr( "value", shareUrl );
        $( "#scatterURLlink" ).attr( "href", scatterUrl );
        //var ourLocation = location.pathname + scatterUrl;
        //history.replaceState({}, "No real title here", '');
        //window.location.replace(currentLocation);

     })
     .fail(function() {
       alert( "There was some sort of problem -- please reload the page" );
     });
   }

   function getAllSubjects() {
     filename = "https://fetch-bill-statuses.appspot.com/listsubjects";
     $.getJSON( filename, function( data ) {
       policies = data.policies;
       for (policy in policies) {
         if (policy) {
           policieslist.push(policy)
         }
       }
       legsubjects = data.legislativesubjects;
       for (subject in legsubjects) {
         legsubjectslist.push(subject)
       }
     })
     .done(function() {
       listSubjects();
     })
     .fail(function() {
       alert( "There was some sort of problem -- please reload the page" );
     });
   }

   function listSubjects() {
     subjectsarray.length = 0;
     $(".subjecttypelabel").empty();
     $('#subjectlisting, #splashsubjectlisting').empty();
     if (subjecttype == "policy") {
       $(".subjecttypelabel").append("Choose a Policy Area:");
       $("#showbutton").hide();
       subjectsarray = policieslist.slice(0);
     } else {
       $(".subjecttypelabel").append("Browse all Legislative Subjects (long):");
       $("#showbutton").show();
       subjectsarray = legsubjectslist.slice(0);
     }
     subjectsarray.sort();
     var auxArr = [];
     $.each(subjectsarray, function(i, subject) {
         auxArr[i] = "<option value='" + subject + "'>" + subject + "</option>";
       });
     $('#subjectlisting, #splashsubjectlisting').append(auxArr.join(''));
   }


  function getAllScores(mycongress) {
    var filename = "https://fetch-bill-statuses.appspot.com/fetchnomscores?congress=" + mycongress;
    $.getJSON( filename, function( data ) {
      scores = data;
      $.each(scores, function(i, score) {
        var bioid = score.bioguide_id;
        var memberbase = score.chamber;
        if (memberbase == "House" || memberbase == "Senate") {
          if (members[memberbase][bioid]) {
            if (members[memberbase][bioid][congress]) {
              members[memberbase][bioid][congress]["dim1"] = score.nominate_dim1
              members[memberbase][bioid][congress]["dim2"] = score.nominate_dim2;
            }
          } else {
            console.log("No match for:" + bioid);
            console.log(score);
          }
        }
       });
    })
    .done(function() {
      //did the caller specify any parameters?
      if (location.search) {
        querysearch();
      } else {
        subjecttype = $( "#subjecttype option:selected" ).val();
        subject = $( "#subjectlisting option:selected" ).val();
        subjectSearch(subject);
      }

      //$('#please-wait').modal('hide');

    })
    .fail(function() {
      alert( "There was some sort of problem -- please reload the page" );
    });
  }

   function getAllMembers() {
     filename = "https://fetch-bill-statuses.appspot.com/fetchmembers";
     $.getJSON( filename, function( data ) {
       members = data;
     })
     .done(function() {
       congresses = members.Congresses;
       //pickMembers();
       var auxArr = [];
       $.each(congresses, function(i, congressnum) {
         auxArr[i] = "<option value='" + congressnum + "'>" + congressnum + "</option>";
        });
        $('#congress').append(auxArr.join(''));
        congress = congresses[congresses.length -1]
        $("#congress").val(congress);
        getAllScores(congress);
     })
     .fail(function() {
       alert( "There was some sort of problem -- please reload the page" );
     });
   }

   function plotscores(memberscores) {
     $("#subjectresults").empty();
     var margin = {top: 100, right: 100, bottom: 100, left: 100},
         width = graphDivWidth - margin.left - margin.right,
         height = (graphDivWidth * 0.52) - margin.top - margin.bottom;

     var x = d3.scaleLinear()
         .range([0, width]);

     var y = d3.scaleLinear()
         .range([height, 0]);

     var xAxis = d3.axisBottom(x);

     var yAxis = d3.axisLeft(y);

     // Define the div for the tooltip
     var div = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

     var svg = d3.select("#subjectresults").append("svg")
         .attr("width", width + margin.left + margin.right)
         .attr("height", height + margin.top + margin.bottom)
       .append("g")
         .attr("transform", "translate(" + margin.left + "," + margin.top + ")");          // let the axis do its thing

     //x.domain(d3.extent(memberscores, function(d) { return d.dim1; }));
     x.domain([-1, 1]);
     y.domain([0, d3.max(memberscores, function(d) { return d.Subjectscore; })]);

     var chambertitle = $( "#chamber option:selected" ).text();
     var graphTitle = "Polarization vs Engagement for '" + subject + "' in the " + congress + "th " + chambertitle;

     svg.append("text")
         .attr("y", -50)
         .attr("class", "Plottitle")
         .text(graphTitle);

     svg.append("g")
         .attr("class", "x axis")
         .attr("transform", "translate(0," + height + ")")
         .call(xAxis)

         // text label for the x axis
     svg.append("text")
         .attr("transform",
               "translate(" + (width/2) + " ," +
                              (height + 40) + ")")
         .style("text-anchor", "middle")
         .text("DW-NOMINATE Score (Dimension 1)");

     svg.append("text")
         .attr("transform",
               "translate(" + (width*.2) + " ," +
                              (height + 30) + ")")
         .style("text-anchor", "middle")
         .text("Liberal");

     svg.append("text")
         .attr("transform",
               "translate(" + (width*.8) + " ," +
                              (height + 30) + ")")
         .style("text-anchor", "middle")
         .text("Conservative");

     svg.append("g")
         .attr("class", "y axis")
         .call(yAxis)

     svg.append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", -50)
        .attr("x",0 - (height / 2))
        .attr("dy", "1em")
        .style("text-anchor", "middle")
        .text("Subject engagement score");

     svg.selectAll(".dot")
         .data(memberscores)
       .enter().append("circle")
         .attr("class", "dot")
         .attr("r", 3.5)
         .attr("cx", function(d) {
           if (d.dim1) {
             return x(d.dim1);
           } else {
             return x(0);
           }
         })
         .attr("cy", function(d) { return y(d.Subjectscore); })
         .attr("fill", function(d) {
            if (d.Party == "R") {
              return "red";
            } else if (d.Party == "D") {
              return "blue";
            }
            return "purple";
          })
          .on('click', function(d, i) {
            console.log("Member: " + JSON.stringify(d));
          })
          .on("mouseover", function(d, i) {
            d3.select(this)
                .attr('r', 8);
            div.transition()
                .duration(50)
                .style("opacity", .95);
            div	.html(d.Name + "<br/>Sponsored: " + d.Sponsored + "</a> Cosponsored: " + d.Cosponsored)
                .style("left", (d3.event.pageX) + "px")
                .style("top", (d3.event.pageY - 28) + "px");
            })
        .on("mouseout", function(d) {
            d3.select(this)
              .attr('r', 3.5);
            div.transition()
                .duration(1000)
                .style("opacity", 0);
        });

   }

   function buildMemberSearch(subject, member, subjecttype, sponsorship) {
     var srchStem = "https://www.congress.gov/advanced-search/command-line?query=";
     if (congress == "all") {
       const myparts = congresses.map(x => "congressId:" + x);
       var congresspart = myparts.join(' OR ');
     } else {
       var congresspart = "congressId:"+ congress ;
     }
     if (subjecttype == "policy") {
       var subjectpart = 'billPolicyArea:"' + subject + '"';
     } else {
       var subjectpart = 'billSubjectTerm:"' + subject + '"';
     }
     var querybit = "(" + subjectpart + " AND " + sponsorship + ':' + member + ") AND (" + congresspart + ")";
     return srchStem + encodeURI(querybit);
   }

   function keysrt(arr, key, reverse) {
       var sortOrder = 1;
       if(reverse){
           sortOrder = -1;
       }
       return arr.sort(function(a, b) {
           var x = a[key],
               y = b[key];

           return sortOrder * ((x < y) ? -1 : ((x > y) ? 1 : 0));
       });
   }
   </script>
 </div>
   <footer class="footer">
     <div class="container">
       <span class="text-muted">  <p>Design and contruction by Ed Sperr, M.L.I.S. (<a href="mailto:ed_sperr@hotmail.com">ed_sperr@hotmail.com</a>)   |
         Data from <a href="https://www.gpo.gov/fdsys/bulkdata/BILLSTATUS">GPO</a>  |   Charting tools from  <a href="https://developers.google.com/chart/interactive/docs/gallery/barchart" target="_blank">Google Charts</a>
        | See the code at <a href="https://github.com/esperr/members-by-interest">GitHub</a></p></span>
     </div>
   </footer>
 </body>
</html>
