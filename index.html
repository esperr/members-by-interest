<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
  <title>Find a Member by Interest</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <link rel="stylesheet" href="byinterest.css">
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-433406-13"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-433406-13');
</script>

</head>

<!--
Designed and built by Ed Sperr (esperr@uga.edu or ed_sperr@hotmail.com)
-->
<body>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <div class="container">

  <div id="topbanner" class="jumbotron">
    <h1>Members by Interest</h1>
    <a id="about" class="label label-default" href="about.html">About Members by Interest</a>
  </div>
  <div class="row">
    <div class="col-sm-12 col-md-12 col-lg-12">


<div id="searchoptions">
  <div class="search">Chamber and years:

  <select id="chamber">
      <option value="house" selected>House of Representatives</option>
      <option value="senate">Senate</option>
    </select>

  <select id="congress">
      <option value="113" selected>113</option>
      <option value="114">114</option>
      <option value="115">115</option>
      <option value="all">113-115</option>
    </select>th Congress
  </div>

  <div class="search">

    <a id="subjecttoggle" href="#">All Members by Policy Area or Subject</a> | <a id="membertoggle" href="#">View Interests for single Member</a>
  </div>

    <!--
    <div id="togglesubject" class="btn-group btn-group-toggle" data-toggle="buttons">
      <label class="btn btn-primary btn-sm active">
        <input type="radio" name="subjecttype" value="policy" autocomplete="off" checked> Policy Area
      </label>
      <label class="btn btn-primary btn-sm">
        <input type="radio" name="subjecttype" value="subject" autocomplete="off"> Legislative Subjects
      </label>
    -->
    Subject type: <select id="subjecttype">
        <option value="policy" selected>policy area</option>
        <option value="subject">legislative subject</option>
      </select>
    </div>
  </div>

  <div id="results">
  <div id="membersearch">
      <div id="memberpicker"><label for="memberlisting">Browse all Members</label>
        <select id="memberlisting"></select>
        or <button id="membersearch-trigger" class="btn btn-primary" type="button">Search members</button>
      </div>
         <div id="memberresults">
      </div>
    </div>

  <div id="subjectsearch">
    <br />


      <div id="showbutton">
      <button id="subjectsearch-trigger" class="btn btn-primary" type="button">Search subjects</button>
      or </div>
      <div id="subjectpicker">
      <label id=subjecttypelabel for="subjectlisting"></label>
      <select id="subjectlisting"></select>
    </div>
    <div id="subjectresults">
    </div>
    <!--
    <div id="explainer">
      <p>Loerem Ipsum yada yada yada yada</p>
      <p>More stuff goes here maybe....</p>
    </div>
  -->
  </div>
</div>



</div>
</div>

<div id="search-members" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="search-members">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Search for a Member</h4>
      </div>
      <div class="modal-body">
        <input type="text" id="myMemberInput" placeholder="Search for names.." title="Type in a name">
        <ul id="memberdrop" class="dropdown"></ul>
      </div>
      <div class="modal-footer">

        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div id="search-subjects" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="search-subjects">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Search for a Subject</h4>
      </div>
      <div class="modal-body">
        <input type="text" id="mySubjectInput" placeholder="Search for subject..." title="Type in a word found in a subject">
        <ul id="subjectdrop" class="dropdown"></ul>
      </div>
      <div class="modal-footer">

        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div id="sharing-link" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Share this search</h4>
      </div>
      <div class="modal-body">
        <input type="text" id="sharingUrlcontent">
      </div>
      <div class="modal-footer">
        <p>Copy the link above</p>
      </div>
    </div>
  </div>
</div>

   <script>
   //did the caller specify any parameters?
   var queryDict = {};
   if (location.search) {

     location.search.substr(1).split("&").forEach(function(item) {
         queryDict[item.split("=")[0]] = item.split("=")[1]
     })
     //alert(JSON.stringify(queryDict));
     if (queryDict["congress"]) { $("#congress").val(queryDict["congress"]); }
     if (queryDict["chamber"]) { $("#chamber").val(queryDict["chamber"]); }
     if (queryDict["subjecttype"]) { $("#subjecttype").val(queryDict["subjecttype"]); }
   }

   var chamber = $( "#chamber option:selected" ).val();
   var congress = $( "#congress option:selected" ).val();

   var subjectsarray = [];
   var subjecttype;
   var currentLocation = location.hostname + location.pathname;
   //var type = $('input[name=searchtype]:checked').val();

   var members;
   var filenameStem = "https://esperr.github.io/members-by-interest/data/"

   //grab our members first!
   getMembers();
   google.charts.load('current', {packages: ['corechart', 'bar']});

   //start by showing only subject search
   if (queryDict["member"]) {
     $( "#membersearch" ).show();
     $( "#subjectsearch" ).hide();
     //topsubjects(queryDict["member"]);
   } else {
     $( "#membersearch" ).hide();
     $( "#showbutton" ).hide();
   }

   $( "#subjectlisting" ).change(function() {
     subject = $( "#subjectlisting option:selected" ).val();
     memberrank(subject);
   });

   $( "#subjecttoggle" ).click(function() {
     $( "#membersearch" ).hide();
     $( "#subjectsearch" ).show();
   });

   $( "#subjectsearch-trigger" ).click(function() {
     $( "#search-subjects" ).modal();
   });

   $( "#memberlisting" ).change(function() {
     member = $( "#memberlisting option:selected" ).val();
     topsubjects(member);
   });

   $( "#membertoggle" ).click(function() {
     $( "#membersearch" ).show();
     $( "#subjectsearch" ).hide();
     member = $( "#memberlisting option:selected" ).val();
     topsubjects(member);
     //type = "member";
   });

   $( "#membersearch-trigger" ).click(function() {
     $( "#search-members" ).modal();
   });

   $( "#subjectresults" ).on( "click", ".shareLink", function() {
      $('#sharing-link').modal();
   });

   $( "#memberresults" ).on( "click", ".shareLink", function() {
      $('#sharing-link').modal();
   });

   //$('#togglesubject input').on('change', function() {
  //   getSubjects();
  // });
  $( "#subjecttype" ).change(function() {
    subjecttype = $( "#subjecttype option:selected" ).val();
    getSubjects();
  });

   //$('#memberdrop a').on('click', function() {
  //   alert("clicked!");
   //});

   $( "#memberdrop" ).on( "click", ".listmember", function() {
     var member = $( this ).data("bioid");
     topsubjects(member);
     $( "#memberlisting" ).val(member);
     $( "#search-members" ).modal("hide");
    });

   $( "#subjectdrop" ).on( "click", ".listsubject", function() {
     var selectsubject = $( this ).html();
     subject = selectsubject.replace(/ /g, '_');
     memberrank(subject);
     $( "#subjectlisting" ).val(subject);
     $( "#search-subjects" ).modal("hide");
    });

   $( "#congress" ).change(function() {
     congress = $( "#congress option:selected" ).val();
     getMembers();
   });

   $( "#chamber" ).change(function() {
     chamber = $( "#chamber option:selected" ).val();
     pickMembers();
     getSubjects();
   });

   $( "#myMemberInput" ).keyup(function() {
     $( "#memberdrop" ).empty();
     var input = $( "#myMemberInput" ).val();
     filter = input.toUpperCase();
     $.each(members, function(i, member)
       {
         if (chamber == "house" && member['district']) {
           var matchstr = member.fullname.replace(/Rep. /, '');
           if (matchstr.toUpperCase().indexOf(filter) > -1) {
             $( "#memberdrop" ).append("<li><a class='listmember' href='#'>" + matchstr + "</a></li>");
             $( ".listmember" ).last().data( "bioid", member.bioid );
           }
         }
         if (chamber == "senate" && !member['district']) {
           var matchstr = member.fullname.replace(/Sen. /, '');
           if (matchstr.toUpperCase().indexOf(filter) > -1) {
             $( "#memberdrop" ).append("<li><a class='listmember' href='#'>" + matchstr + "</a></li>");
             $( ".listmember" ).last().data( "bioid", member.bioid );
           }
         }
     });
    });

     $( "#mySubjectInput" ).keyup(function() {
       $( "#subjectdrop" ).empty();
       var input = $( "#mySubjectInput" ).val();
       filter = input.toUpperCase();
       $.each(subjectsarray, function(i, subject)
         {
             var matchstr = subject.replace(/_/g, ' ');
             if (matchstr.toUpperCase().indexOf(filter) > -1) {
               $( "#subjectdrop" ).append("<li><a class='listsubject' href='#'>" + matchstr + "</a></li>");
             }
       });
     });


   function pickMembers() {
     $('#memberlisting').empty();
     var sortedMembers = membersort(members);
     var auxArr = [];
     $.each(sortedMembers, function(i, member)
       {
         if (chamber == "house" && member['district']) {
           auxArr[i] = "<option value='" + member['bioid'] + "'>" + member['fullname'] + "</option>";
         }
         if (chamber == "senate" && !member['district']) {
           auxArr[i] = "<option value='" + member['bioid'] + "'>" + member['fullname'] + "</option>";
         }
       });
      $('#memberlisting').append(auxArr.join(''));

   }

   function memberrank(subject) {
     //subject = $( "#subjectlisting option:selected" ).val();
     var ranklist = [];
     var memberlink = "https://www.congress.gov/member/";
     $.each( allsubjects[subject], function( key, value ) {
       var sponsored = value['sponsored'] || 0;
       var cosponsored = value['cosponsored'] || 0;
       var score = (sponsored*3) + cosponsored;
       //sort chambers here?
       if (score > 0) {
         var result = members.filter(function( member ) {
           return member.bioid == key;
         });
         var mymember = (result[0]);
         if (mymember) {
           var memberobj = { "fullname": mymember.fullname, "firstname": mymember.firstname, "lastname": mymember.lastname, "bioid": key, "score": score, "sponsored": sponsored, "cosponsored": cosponsored };
           if (chamber == "house" && mymember.district) {
             ranklist.push(memberobj);
           }
           if (chamber == "senate" && !mymember.district) {
             ranklist.push(memberobj);
           }
         }
       }
       });
       var ranked = keysrt(ranklist, 'score', 'reverse');
       $( "#subjectresults" ).empty();
       var chambertitle = $( "#chamber option:selected" ).text();
       var subjectname = $( "#subjectlisting option:selected" ).text();
       var congressname = $( "#congress option:selected" ).text();
       var subjectrestitle = "Members of the " + congressname + "th " + chambertitle + " sorted by '" + subjectname + "'";
       $( "#subjectresults" ).append( "<h2>" + subjectrestitle + "</h2>" );
       $(" #subjectresults" ).append('<p>Share this search: <a href="#!" class="shareLink">Link</a></p>');
       for (i=0; i<ranked.length; i++) {
           var membersearchStr = memberlink + ranked[i].firstname + "-" + ranked[i].lastname + "/" + ranked[i].bioid;
           var mydiv = "<div class='member'><span class='name'><a href='" + membersearchStr + "' target='member'>" + ranked[i].fullname + "</a></span>";
           var srchSubject = subject.replace(/_/g, ' ');
           var srchSponLink = buildMemberSearch(srchSubject, ranked[i].bioid, subjecttype, "billSponsor");
           mydiv = mydiv + "<br /><span class='counts'>Sponsored: <a href='" + srchSponLink + "' target='sponsorship'>" + ranked[i].sponsored + "</a>"
           var srchCoSponLink = buildMemberSearch(srchSubject, ranked[i].bioid, subjecttype, "billCosponsor");
           mydiv = mydiv + " Cosponsored: <a href='" + srchCoSponLink + "' target='sponsorship'>" + ranked[i].cosponsored + "</a></span></div>"
           $( "#subjectresults" ).append( mydiv );
       }
       var myQuerystring = "congress=" + congress + "&chamber=" + chamber + "&subjecttype=" + subjecttype + "&subject=" + subject;
       var shareUrl = currentLocation + "?" +  myQuerystring;
       $( "#sharingUrlcontent" ).attr( "style", "width: 35em;" );
       $( "#sharingUrlcontent" ).attr( "value", shareUrl );
   }

   function topsubjects(member) {
     var interests = [];
     $( "#memberresults" ).empty();
     $(" #memberresults" ).append('<p>Share this search: <a href="#!" class="shareLink">Link</a></p>');
     var myQuerystring = "congress=" + congress + "&chamber=" + chamber + "&subjecttype=" + subjecttype + "&member=" + member;
     var shareUrl = currentLocation + "?" +  myQuerystring;
     $( "#sharingUrlcontent" ).attr( "style", "width: 35em;" );
     $( "#sharingUrlcontent" ).attr( "value", shareUrl );
     $.each( allsubjects, function( key, value ) {
       var scanSubject = allsubjects[key];
       if (scanSubject[member]) {
         var sponsored = scanSubject[member]['sponsored'] || 0;
         var cosponsored = scanSubject[member]['cosponsored'] || 0;
         var bills = sponsored + cosponsored;
         var proportion = bills / scanSubject['total'];
         var subjectObj = { "member": member, "subject": key, "bills": bills, "proportion": proportion };
         interests.push(subjectObj);
       }
     });
     var ranked = keysrt(interests, 'proportion', 'reverse');
     var proparray = [];
     var labels = ['Subject', 'Proportion',]
     proparray.push(labels);
     for (i=0; i<ranked.length; i++){
       var nounder = ranked[i].subject.replace(/_/g, ' ');
       proparray.push([nounder, ranked[i].proportion]);
     }
     if (google.visualization.arrayToDataTable) {
       drawchart(proparray, member);
      } else {
       drawpause();
      }

      function drawpause() {
      setTimeout(function() {
        console.log("no!");
        if (google.visualization.arrayToDataTable) {
          drawchart(proparray, member);
        } else {
          drawpause();
        }
        }, 500);
      }
   }

   function getSubjects() {
     subjectsarray.length = 0;
     subjecttype = $( "#subjecttype option:selected" ).val();
     //subjecttype = $('input[name=subjecttype]:checked').val();
     //subjecttype = "policy";
     $("#subjecttypelabel").empty();
     $('#subjectlisting').empty();
     if (subjecttype == "policy") {
       var filename = filenameStem + "policyareasbymember_" + congress + "_" + chamber + ".js";
       $("#subjecttypelabel").append("Choose a Policy Area:");
       $("#showbutton").hide();
     } else {
       $("#subjecttypelabel").append("Browse all Legislative Subjects (long):");
       $("#showbutton").show();
       var filename = filenameStem + "subjectsbymember_" + congress + "_" + chamber + ".js";
     }
     $.getJSON( filename, function( data ) {
       allsubjects = data;
       for (subject in allsubjects) {
         subjectsarray.push(subject);
         subjectsarray.sort();
       }
       var auxArr = [];
       $.each(subjectsarray, function(i, subject)
         { var nounder = subject.replace(/_/g, ' ');
           auxArr[i] = "<option value='" + subject + "'>" + nounder + "</option>";
         });
       $('#subjectlisting').append(auxArr.join(''));
     })
     .done(function() {
       if (queryDict["subject"]) { $("#subjectlisting").val(queryDict["subject"]); }
       var mysubject = $( "#subjectlisting option:selected" ).val();
       memberrank(mysubject);
       if (queryDict["member"]) { $("#memberlisting").val(queryDict["member"]);
          $( "#membersearch" ).show();
          $( "#subjectsearch" ).hide();
          topsubjects(queryDict["member"]);
        }
       //member = $( "#memberlisting option:selected" ).val();
       //topsubjects(member);
     })
     .fail(function() {
       alert( "There was some sort of problem -- please reload the page" );
     });
  }

   function getMembers() {
     filename = filenameStem + "members_" + congress + ".js";
     $.getJSON( filename, function( data ) {
       members = data;
       pickMembers();
     })
     .done(function() {
       getSubjects();
     })
     .fail(function() {
       alert( "There was some sort of problem -- please reload the page" );
     });
   }

   function drawchart(proparray, member) {
     var result = members.filter(function( mymember ) {
       return mymember.bioid == member;
     });
     titletext = result[0].fullname;
     newHeight = proparray.length * 20;
     var divStyle = "width: 900px; height:" + String(newHeight) + "px;"
     $( "#memberresults" ).append("<div id='chart_div' style='" + divStyle +"'></div>");
     var data = google.visualization.arrayToDataTable(proparray);
     var titlecongress = $( "#congress option:selected" ).text() + "th Congress";
     if (subjecttype == "subject") {
       titletext = titletext + ": Bills and Resolutions by Legislative Subject, " + titlecongress;
     } else {
       titletext = titletext + " : Bills and Resolutions by Policy Area, " + titlecongress;
     }

    var options = {
      chart: {
                  title: titletext,
                  subtitle: 'Proportion of all Bills and Resolutions sponsored and cosponsored for that topic',
                },
      chartArea: {width: '50%'},
      hAxis: {
        title: 'Proportion',
        minValue: 0
      },
      vAxis: {
        title: 'Subject'
      },
      bars: 'horizontal' // Required for Material Bar Charts.

    };

    var chart = new google.charts.Bar(document.getElementById('chart_div'));

    function selectHandler() {
    var selectedItem = chart.getSelection()[0];
    if (selectedItem) {
      var chartsubject = data.getValue(selectedItem.row, 0);
      var chartLink = buildMemberSearch(chartsubject, member, subjecttype, "billSponsorOrCosponsor");
      window.open(chartLink,'_blank');
     }
    }

    google.visualization.events.addListener(chart, 'select', selectHandler);
    chart.draw(data, google.charts.Bar.convertOptions(options));
    }

    function buildMemberSearch(subject, member, subjecttype, sponsorship) {
      var srchStem = "https://www.congress.gov/advanced-search/command-line?query=";
      if (congress == "all") {
        var congresspart = "congressId:113 OR congressId:114 OR congressId:115";
      } else {
        var congresspart = "congressId:"+ congress ;
      }
      if (subjecttype == "policy") {
        var subjectpart = 'billPolicyArea:"' + subject + '"';
      } else {
        var subjectpart = 'billSubjectTerm:"' + subject + '"';
      }
      var querybit = "(" + subjectpart + " AND " + sponsorship + ':' + member + ") AND (" + congresspart + ")";
      return srchStem + encodeURI(querybit);
    }


   function membersort(sortMembers) {
     var sorted = keysrt(sortMembers, "lastname");
     return sorted;
   }

   function membermatch(bioid) {
     for (i=0; i<members.length; i++) {
       if (members[i].bioid == bioid) return members[i];
     }
   }

   function keysrt(arr, key, reverse) {
       var sortOrder = 1;
       if(reverse){
           sortOrder = -1;
       }
       return arr.sort(function(a, b) {
           var x = a[key],
               y = b[key];

           return sortOrder * ((x < y) ? -1 : ((x > y) ? 1 : 0));
       });
   }
   </script>
 </div>
   <footer class="footer">
     <div class="container">
       <span class="text-muted">  <p>Design and contruction by Ed Sperr, M.L.I.S. (<a href="mailto:ed_sperr@hotmail.com">ed_sperr@hotmail.com</a>)   |
         Data from <a href="https://www.gpo.gov/fdsys/bulkdata/BILLSTATUS">GPO</a>  |   Charting tools from  <a href="https://developers.google.com/chart/interactive/docs/gallery/barchart" target="_blank">Google Charts</a>
        | See the code at <a href="https://github.com/esperr/members-by-interest">GitHub</a></p></span>
     </div>
   </footer>
 </body>
</html>
